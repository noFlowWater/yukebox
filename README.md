# YukeBox

> Self-hosted YouTube audio player for Bluetooth speakers

[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](LICENSE)
[![Docker](https://img.shields.io/badge/Docker-ready-blue.svg)](docker-compose.yml)
[![Version](https://img.shields.io/badge/version-0.2.0-green.svg)](https://github.com/noFlowWater/yukebox/releases)
[![GHCR](https://img.shields.io/badge/GHCR-images-blue.svg)](https://github.com/noFlowWater/yukebox/pkgs/container)
[![Docker Hub](https://img.shields.io/badge/Docker%20Hub-images-blue.svg)](https://hub.docker.com/u/noyusu)

Search or paste a YouTube URL — YukeBox streams audio directly to your Bluetooth speaker via the web.
No cloud. No subscriptions. Just your music, your speaker, your server.

<!-- TODO: Add screenshot or demo GIF here -->
<!-- ![YukeBox Demo](docs/demo.gif) -->

---

## Features

- **Instant Playback** — Search YouTube or paste a URL, audio starts in seconds
- **Queue Management** — Add, reorder, remove tracks with auto-advance
- **Scheduled Playback** — Set alarms or timed playlists that auto-start
- **Multi-Speaker** — Register and switch between Bluetooth speakers on the fly
- **Bluetooth Management** — Scan, pair, and connect BT speakers from the web UI with auto-reconnect
- **Favorites** — Save your favorite tracks for quick access
- **Real-time Status** — Live playback updates via Server-Sent Events
- **Multi-User Auth** — Role-based access control (Admin / User)
- **Accessibility** — Dark/light theme, text scaling, reduced motion, timezone support
- **One-Command Deploy** — Docker Compose with automated setup script

---

## Quick Start

### Prerequisites

- **Linux** (Ubuntu 22.04+, Fedora 34+, Debian 12+)
- **Docker** + Docker Compose
- **PulseAudio** or **PipeWire** (with `pipewire-pulse`)
- **Bluetooth speaker** paired and connected

### Option A: Pre-built Images (Recommended)

```bash
git clone https://github.com/noFlowWater/yukebox.git
cd yukebox
./setup.sh
```

`setup.sh` handles everything: detects your audio socket, generates secrets, and launches the containers.

Open **http://localhost:3000** and create your first account.

### Option B: Pull from Registry

Pre-built multi-arch images (amd64 + arm64) are available on GHCR and Docker Hub:

```bash
# GHCR
docker pull ghcr.io/noflowwater/yukebox-backend:latest
docker pull ghcr.io/noflowwater/yukebox-frontend:latest

# Docker Hub
docker pull noyusu/yukebox-backend:latest
docker pull noyusu/yukebox-frontend:latest
```

To use pre-built images, edit `docker-compose.yml` — uncomment the `image:` lines and comment out `build:`:

```yaml
services:
  backend:
    image: ghcr.io/noflowwater/yukebox-backend:latest
    # build: ./backend
```

### Uninstall

```bash
./cleanup.sh          # interactive
./cleanup.sh --all    # remove everything
```

---

## Bluetooth Setup

YukeBox can manage Bluetooth speakers directly from the **Admin Panel** — scan for devices, pair, connect, and disconnect without touching the terminal.

1. Open the Admin Panel
2. Scroll to **Bluetooth Devices**
3. Click **Scan** to discover nearby speakers
4. Click **Pair & Connect** on any discovered device

Connected speakers are automatically registered and ready to use. Auto-reconnect handles temporary disconnections.

<details>
<summary><b>Alternative: CLI pairing (before running setup)</b></summary>

```bash
bluetoothctl scan on
bluetoothctl pair <MAC>
bluetoothctl connect <MAC>
bluetoothctl trust <MAC>

# Verify PulseAudio sees it
pactl list sinks short
# Should show: bluez_sink.XX_XX_XX_XX_XX_XX.*
```

Or use your desktop's Bluetooth settings (GNOME Settings, KDE System Settings, etc.)
</details>

---

## Configuration

All settings live in `.env` (auto-generated by `setup.sh`):

| Variable | Default | Description |
|----------|---------|-------------|
| `PORT` | `3000` | Web UI port |
| `NODE_ENV` | `production` | Environment |
| `PULSE_SOCKET` | (auto-detected) | Host PulseAudio socket path |
| `PULSE_COOKIE` | (auto-detected) | PulseAudio cookie path |
| `JWT_SECRET` | (auto-generated) | Auth token signing key |
| `MPV_SOCKET` | `/tmp/mpv-socket` | mpv IPC socket (advanced) |
| `DB_PATH` | `/app/data/yukebox.db` | SQLite database path (advanced) |

---

## Architecture

```
┌─────────────────────────────────────────────┐
│  Browser (any device on network)            │
│  http://host:3000                           │
└──────────────┬──────────────────────────────┘
               │
┌──────────────▼──────────────────────────────┐
│  Docker Compose                             │
│  ┌────────────────┐  ┌───────────────────┐  │
│  │  Frontend       │  │  Backend          │  │
│  │  Next.js 15     │──│  Fastify + TS     │  │
│  │  shadcn/ui      │  │  SQLite           │  │
│  │  :3000          │  │  mpv + yt-dlp     │  │
│  └────────────────┘  │  SSE streaming     │  │
│                       │  :4000 (internal)  │  │
│                       └──────┬──┬──────────┘  │
└──────────────────────────────┼──┼──────────────┘
                 PulseAudio ───┘  └─── D-Bus (bluetoothctl)
                       ┌─────────────────────┐
                       │  Bluetooth Speaker   │
                       └─────────────────────┘
```

| Layer | Stack |
|-------|-------|
| Backend | Fastify + TypeScript (ESM) |
| Auth | JWT (jose) + httpOnly Cookie + bcryptjs |
| Database | SQLite (better-sqlite3) |
| Bluetooth | bluetoothctl via D-Bus system bus |
| Frontend | Next.js 15 + shadcn/ui |
| Real-time | Server-Sent Events (SSE) |
| Deploy | Docker Compose |
| Images | GHCR + Docker Hub (linux/amd64, linux/arm64) |

Only port **3000** is exposed. The frontend proxies API requests internally — no CORS configuration needed.

---

## HTTPS (Optional)

For external access, use nginx as a reverse proxy. See [`nginx.example.conf`](nginx.example.conf) for a starter template.

---

## Development

```bash
# Backend (terminal 1)
cd backend && npm install && npm run dev

# Frontend (terminal 2)
cd frontend && npm install && npm run dev
```

Backend runs on `:4000`, frontend on `:3000`. Next.js rewrites proxy `/api/*` to the backend.

```bash
# Run backend tests
cd backend && npm test
```

---

## Troubleshooting

<details>
<summary><b>No sound from Bluetooth speaker</b></summary>

1. Check connection: `bluetoothctl devices Connected`
2. Check PulseAudio: `pactl list sinks short`
3. Restart audio: `systemctl --user restart pulseaudio`
</details>

<details>
<summary><b>"PulseAudio socket not found" during setup</b></summary>

- PipeWire users: install `pipewire-pulse` and restart: `systemctl --user restart pipewire-pulse`
- Verify socket: `ls ${XDG_RUNTIME_DIR}/pulse/native`
</details>

<details>
<summary><b>Can't connect from phone/other device</b></summary>

- Use `http://<host-ip>:3000` instead of `localhost`
- Check firewall: `sudo ufw allow 3000`
</details>

<details>
<summary><b>Container can't access PulseAudio</b></summary>

- Verify `PULSE_SOCKET` in `.env` matches your socket path
- Check audio group: your user must be in the `audio` group
</details>

---

## Contributing

Contributions are welcome! See [CONTRIBUTING.md](CONTRIBUTING.md) for guidelines.

---

## License

[MIT](LICENSE)
